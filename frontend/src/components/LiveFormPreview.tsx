import React from 'react';
import { EmbeddableForm } from './EmbeddableForm';
import { FormData, GeneratedForm, SaaSForm, FormField } from '../types/api';

interface LiveFormPreviewProps {
  formData: Partial<FormData>;
  generatedForm: GeneratedForm | null;
  createdForm: SaaSForm | null;
  user?: any;
  extractedDesignTokens: any | null; // New prop
  extractedVoiceAnalysis: any | null; // New prop
}

// Helper to determine if a color is light (simplified for demo)
const isLightColor = (color: string): boolean => {
  if (!color) return false;
  let r, g, b;

  // Handle hex colors
  if (color.startsWith('#')) {
    const hex = color.slice(1);
    if (hex.length === 3) { // #rgb
      r = parseInt(hex[0] + hex[0], 16);
      g = parseInt(hex[1] + hex[1], 16);
      b = parseInt(hex[2] + hex[2], 16);
    } else if (hex.length === 6) { // #rrggbb
      r = parseInt(hex.substring(0, 2), 16);
      g = parseInt(hex.substring(2, 4), 16);
      b = parseInt(hex.substring(4, 6), 16);
    } else {
      return false;
    }
  } 
  // Handle rgb/rgba colors
  else if (color.startsWith('rgb')) {
    const parts = color.match(/\d+/g)?.map(Number);
    if (parts && parts.length >= 3) {
      [r, g, b] = parts;
    } else {
      return false;
    }
  }
  // Handle hsl/hsla colors
  else if (color.startsWith('hsl')) {
    // For simplicity, treat HSL as dark if lightness is low
    const lightnessMatch = color.match(/hsla?\(\s*\d+\s*,\s*\d+%\s*,\s*(\d+)%\s*(?:,\s*\d*\.?\d+)?\)/);
    if (lightnessMatch && lightnessMatch[1]) {
      const lightness = parseInt(lightnessMatch[1]);
      return lightness > 70; // Arbitrary threshold for light HSL
    }
    return false;
  }
  else {
    return false; // Not a recognized color format
  }

  // Calculate luminance (simplified)
  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
  return luminance > 0.7; // Threshold for "light"
};


export const LiveFormPreview: React.FC<LiveFormPreviewProps> = ({
  formData,
  generatedForm,
  createdForm,
  user,
  extractedDesignTokens, // Use new prop
  extractedVoiceAnalysis, // Use new prop
}) => {
  const { url, purpose } = formData; // Removed formLayout

  // Construct a mock GeneratedForm for preview if not yet generated by AI
  const getPreviewForm = (): GeneratedForm => {
    if (generatedForm) {
      return generatedForm;
    }

    // Default styling, potentially overridden by extracted tokens
    const defaultStyling = {
      primaryColor: extractedDesignTokens?.primaryColors?.[0] || '#007bff',
      backgroundColor: extractedDesignTokens?.colorPalette?.find(color => isLightColor(color)) || '#f8f9fa', // Try to find a light color, else use app's light gray
      fontFamily: extractedDesignTokens?.fontFamilies?.[0] || 'system-ui, -apple-system, sans-serif',
      borderRadius: '8px',
      buttonStyle: 'solid',
      maxWidth: '500px', // Default maxWidth for preview
    };

    // Mock fields based on purpose
    let mockFields: FormField[] = [
      { type: 'text', name: 'name', label: 'Your Name', placeholder: 'Enter your name', required: true },
      { type: 'email', name: 'email', label: 'Email', placeholder: 'your@email.com', required: true },
    ];

    if (purpose?.toLowerCase().includes('feedback') || purpose?.toLowerCase().includes('message')) {
      mockFields.push({ type: 'textarea', name: 'message', label: 'Message', placeholder: 'Your message', required: true });
    } else if (purpose?.toLowerCase().includes('lead')) {
      mockFields.push({ type: 'text', name: 'company', label: 'Company', placeholder: 'Your company', required: false });
    }

    // Use extracted messaging for description if available
    const descriptionText = extractedDesignTokens?.messaging?.[0] || 
                            (url ? `This form will adapt to the style of ${url}` : 'Start by entering a website URL.');

    return {
      title: purpose ? `AI Form: ${purpose}` : 'Your AI-Powered Form',
      description: descriptionText,
      fields: mockFields,
      ctaText: purpose?.toLowerCase().includes('subscribe') ? 'Subscribe' : 'Submit',
      thankYouMessage: 'Thank you for your submission!',
      styling: defaultStyling,
      // formLayout: 'inline', // Default to inline as other layouts are removed
    };
  };

  const previewForm = getPreviewForm();
  // const showBranding = user?.subscription_tier !== 'paid'; // Original line

  // Conditional rendering for different layouts
  const renderFormContent = () => {
    if (!url && !purpose && !generatedForm) {
      return (
        <p style={{ color: '#666', textAlign: 'center' }}>
          Enter a URL and purpose to see your form preview here.
        </p>
      );
    }

    // Since other layouts are removed, always render inline
    return (
      <EmbeddableForm
        form={previewForm}
        embedCode={createdForm?.embed_code || "preview-mode"} // Use actual embed code if available
        showBranding={false} // Always hide branding in preview
        onSubmit={(data) => console.log('Preview submission:', data)} // Mock submission
      />
    );
  };

  return (
    <div className="card" style={{ position: 'sticky', top: '20px', maxWidth: '500px' }}> {/* Added maxWidth */}
      <h3 style={{ marginBottom: '16px', textAlign: 'center' }}>Live Preview</h3>
      <div style={{
        border: '1px solid #e1e5e9',
        borderRadius: '8px',
        // Removed padding: '16px',
        backgroundColor: '#f8f9fa',
        minHeight: '300px',
        maxHeight: 'calc(100vh - 250px)', // Set max height for scrolling
        overflowY: 'auto', // Enable vertical scrolling
        overflowX: 'hidden', // Prevent horizontal scrolling
        // Removed alignItems: 'center',
        // Removed justifyContent: 'center',
        position: 'relative',
        // Changed overflow: 'hidden' to overflowX: 'hidden'
      }}>
        {renderFormContent()}
      </div>
      {generatedForm && (
        <div style={{
          marginTop: '16px',
          padding: '12px',
          backgroundColor: '#e8f5e8',
          borderRadius: '6px',
          border: '1px solid #c3e6cb',
          textAlign: 'center',
          fontSize: '14px',
          color: '#155724'
        }}>
          âœ… AI-generated form preview.
        </div>
      )}
    </div>
  );
};